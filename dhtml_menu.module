<?php
/**
 * $Id$
 * @file dhtml_menu.modle
 * Allow click expansion of the menu tree via javascript, with
 * graceful degradation.
 */

/**
 * Implementation of hook_block().
 *
 * Basically a copy of menu_block() -- we're providing our own version
 * of each menu.
 */
function dhtml_menu_block($op = 'list', $delta = '') {
  if ($op == 'list') {
    // Get a list of all menus
    $root_menus = menu_get_menus(true);

    // "Clone" each menu, using DHTML as a prefix
    $blocks = array();
    foreach ($root_menus as $mid => $title) { // $mid is a string in 6.x
      $blocks[$mid]['info'] = t('DHTML: ') . $title;
    }

    return $blocks;
  }
  elseif ($op == 'view') {
    // Get a list of all menus
    $root_menus = menu_get_menus(true);

    // Build the menu tree using DHTML menu special
    // construction functions
    $tree = menu_tree_all_data($delta);
    $data['content'] = theme('dhtml_menu_tree', $tree);

    // Set the block title: if its Navigation menu, use
    // the user's nickname. Otherwise, use the original
    // block name
    global $user;
    if ($user->uid > 0 and $delta == 'navigation') {
      $data['subject'] = $user->name;
    }
    else {
      $data['subject'] = check_plain($root_menus[$delta]);
    }

    return $data;
  }
}

/**
 * Implementation of hook_menu().
 */
function dhtml_menu_menu() {
  $items['admin/settings/dhtml_menu'] = array(
    'description'     => 'Adds new menus with DHTML to reduce page refreshes',
    'file'            => 'dhtml_menu.admin.inc',
    'title'           => 'DHTML Menu',
    'page callback'   => 'drupal_get_form',
    'page arguments'  => array('_dhtml_menu_settings'),
  );

  return $items;
}

/**
 * Implementation of hook_theme().
 */
function dhtml_menu_theme($existing, $type) {
  $theme['dhtml_menu_item'] = array(
    'arguments' => array('item' => array(), 'id' => NULL),
    'file'      => 'dhtml_menu.inc'
  );
  $theme['dhtml_menu_tree'] = array(
    'arguments' => array('tree' => array(), 'parent' => NULL, 'pid' => NULL),
    'file'      => 'dhtml_menu.inc'
  );
  return $theme;
}
